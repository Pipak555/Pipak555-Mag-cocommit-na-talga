import{u as e,r as s,j as n}from"./react-vendor-DAkY0NgE.js";import{u as t,B as i,x as o,C as a,d as c,a as r,b as d,i as l,e as u,h as m,j as h,A as g,D as x}from"./index-BbvEjZj9.js";import{a as f,p as j}from"./paymentService-HK3toL-K.js";import{B as p}from"./badge-Bdu_tSqo.js";import{T as k}from"./theme-toggle-C3pYvPx7.js";import{A as b,a as w,b as v,c as N,d as y,e as B,f as C,g as I}from"./alert-dialog-D9Kc0D1X.js";import{q as D,w as P,c as A,k as S,f as z,e as R,d as T}from"./firebase-vendor-CvoiOdvz.js";import{A as q,i as O,R as E,X as F}from"./icons-vendor-3zhgXMYa.js";import"./maps-vendor-CYGXCXz5.js";import"./utils-vendor-yBsXXcRr.js";import"./ui-vendor-CZx_xpmK.js";import"./dropdown-menu-BRbzCJvi.js";const G=()=>{const G=e(),{user:L}=t(),[U,$]=s.useState([]),[J,K]=s.useState(!0),[M,Q]=s.useState(!1),[Y,H]=s.useState(!1),[V,W]=s.useState(!1),[X,Z]=s.useState(null);s.useEffect(()=>{if(!L)return;K(!0);const e=D(A(h,"bookings"),P("hostId","==",L.uid)),s=S(e,e=>{const s=e.docs.map(e=>{const s=e.data();return{id:e.id,...s}});s.sort((e,s)=>{const n=new Date(e.createdAt||0).getTime();return new Date(s.createdAt||0).getTime()-n});const n=s.filter(e=>{const s=e.hostId+""==L.uid+"";return!s&&e.hostId,s});$(n),K(!1),0===n.length&&s.length,0===n.length&&(_(L.uid),ee(L.uid))},e=>{K(!1),u.error("Failed to load bookings: "+(e.message||"Unknown error")),se()});return()=>s()},[L]);const _=async e=>{try{const s=D(A(h,"bookings"));(await T(s)).docs.map(e=>({id:e.id,...e.data()})).filter(s=>s.hostId+""==e+"").length}catch(s){s.code}},ee=async e=>{try{const s=D(A(h,"bookings"),P("hostId","==",e));(await T(s)).docs.map(e=>({id:e.id,...e.data()}))}catch(s){s.code}},se=async()=>{if(L)try{const e=await m({hostId:L.uid});$(e)}catch(e){u.error("Failed to load bookings: "+(e.message||"Unknown error"))}},ne=(e,s)=>{if(Z({id:e,action:s}),"confirmed"===s)Q(!0);else{const s=U.find(s=>s.id===e);"confirmed"===s?.status?W(!0):H(!0)}},te=async()=>{if(X)try{const i=await z(R(h,"bookings",X.id));if(!i.exists())return void u.error("Booking not found");const o={id:i.id,...i.data()},a=o.status;if(await g(X.id,{status:X.action}),"confirmed"===X.action&&"confirmed"!==a)try{if(!(await f(o)).success)throw Error("Payment processing failed");u.success(`Booking confirmed! Payment of ${l(o.totalPrice||0)} processed.`)}catch(e){return await g(X.id,{status:a}),void u.error("Payment failed: "+(e.message||"Insufficient balance or processing error"))}if("cancelled"===X.action&&"confirmed"===a)try{const e=await j(o,"host");if(!e.success)throw Error("Refund processing failed");u.success(`Booking cancelled. ${l(e.refundAmount||0)} has been refunded to guest's wallet.`)}catch(s){u.warning("Booking cancelled, but refund could not be processed. Please contact support.")}else"cancelled"===X.action&&u.success("Booking cancelled");if("confirmed"===X.action)try{const e=await z(R(h,"bookings",X.id));if(e.exists()){const s=e.data(),t=await z(R(h,"listing",s.listingId));if(t.exists()){const e=t.data();try{const n=await z(R(h,"users",s.guestId));if(n.exists()){const t=n.data();await x(t.email||s.guestId,t.fullName||"Guest",e.title||"Your Booking",e.location||"",s.checkIn,s.checkOut,s.guests||1,s.totalPrice||0,X.id)?u.success("Booking confirmed and confirmation email sent to guest!"):u.warning("Booking confirmed, but email could not be sent. Please check EmailJS configuration.")}else u.warning("Booking confirmed, but guest email not found.")}catch(n){"permission-denied"===n.code?u.error("Permission denied: Cannot access guest information. Please check Firestore rules."):u.warning("Booking confirmed, but could not fetch guest information for email.")}}else u.success("Booking confirmed, but listing details not found.")}else u.success("Booking confirmed, but details not found for email.")}catch(t){u.success("Booking confirmed, but email could not be sent.")}else"cancelled"===X.action&&"confirmed"!==o?.status&&u.success("Booking declined");Z(null)}catch(i){u.error("Failed to update booking")}finally{Q(!1),H(!1),W(!1)}};return n.jsxs("div",{className:"min-h-screen bg-background",children:[n.jsx("header",{className:"sticky top-0 z-50 border-b bg-card/95 backdrop-blur supports-[backdrop-filter]:bg-card/60 shadow-soft",children:n.jsxs("div",{className:"container mx-auto px-6 py-4 flex justify-between items-center",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx(i,{variant:"ghost",size:"icon",onClick:()=>G("/host/dashboard"),children:n.jsx(q,{className:"h-5 w-5"})}),n.jsx("div",{className:"p-2 rounded-lg bg-secondary/10",children:n.jsx(O,{className:"w-5 h-5 text-secondary"})}),n.jsxs("div",{children:[n.jsx("h1",{className:"text-lg font-bold",children:"Booking Requests"}),n.jsx("p",{className:"text-xs text-muted-foreground",children:"Manage reservations"})]})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(i,{variant:"ghost",size:"icon",onClick:()=>{se()},title:"Refresh bookings",children:n.jsx(E,{className:"h-5 w-5"})}),n.jsx(k,{})]})]})}),n.jsx("div",{className:"max-w-6xl mx-auto p-6",children:J?n.jsx(o,{}):0===U.length?n.jsx(a,{children:n.jsxs(c,{className:"py-12 text-center",children:[n.jsx("p",{className:"text-muted-foreground mb-4",children:"No booking requests"}),n.jsx("p",{className:"text-xs text-muted-foreground",children:"Bookings will appear here when guests make reservation requests for your listings."}),n.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Current host ID: ",L?.uid]})]})}):n.jsx("div",{className:"grid gap-4",children:U.map(e=>n.jsxs(a,{children:[n.jsx(r,{children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs(d,{children:["Booking #",e.id.slice(0,8)]}),n.jsx(p,{children:e.status})]})}),n.jsx(c,{children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"grid grid-cols-3 gap-4 flex-1",children:[n.jsxs("div",{children:[n.jsx("p",{className:"text-sm text-muted-foreground",children:"Check-in"}),n.jsx("p",{className:"font-medium",children:new Date(e.checkIn).toLocaleDateString()})]}),n.jsxs("div",{children:[n.jsx("p",{className:"text-sm text-muted-foreground",children:"Check-out"}),n.jsx("p",{className:"font-medium",children:new Date(e.checkOut).toLocaleDateString()})]}),n.jsxs("div",{children:[n.jsx("p",{className:"text-sm text-muted-foreground",children:"Total"}),n.jsx("p",{className:"font-medium",children:l(e.totalPrice||0)})]})]}),"pending"===e.status&&n.jsxs("div",{className:"flex gap-2",children:[n.jsx(i,{size:"sm",onClick:()=>ne(e.id,"confirmed"),children:"Confirm"}),n.jsx(i,{size:"sm",variant:"destructive",onClick:()=>ne(e.id,"cancelled"),children:"Decline"})]}),"confirmed"===e.status&&new Date(e.checkIn)>=new Date&&n.jsx("div",{className:"pt-4 border-t",children:n.jsxs(i,{variant:"destructive",size:"sm",onClick:()=>ne(e.id,"cancelled"),className:"w-full",children:[n.jsx(F,{className:"h-4 w-4 mr-2"}),"Cancel Booking"]})})]})})]},e.id))})}),n.jsx(b,{open:M,onOpenChange:Q,children:n.jsxs(w,{children:[n.jsxs(v,{children:[n.jsx(N,{children:"Confirm Booking?"}),n.jsx(y,{children:"Are you sure you want to confirm this booking? The guest will be notified and the booking will be finalized."})]}),n.jsxs(B,{children:[n.jsx(C,{onClick:()=>Z(null),children:"Cancel"}),n.jsx(I,{onClick:te,children:"Confirm Booking"})]})]})}),n.jsx(b,{open:Y,onOpenChange:H,children:n.jsxs(w,{children:[n.jsxs(v,{children:[n.jsx(N,{children:"Decline Booking?"}),n.jsx(y,{children:"Are you sure you want to decline this booking request? The guest will be notified and this action cannot be undone."})]}),n.jsxs(B,{children:[n.jsx(C,{onClick:()=>Z(null),children:"Cancel"}),n.jsx(I,{onClick:te,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Decline Booking"})]})]})}),n.jsx(b,{open:V,onOpenChange:W,children:n.jsxs(w,{children:[n.jsxs(v,{children:[n.jsx(N,{children:"Cancel Booking?"}),n.jsxs(y,{children:["Are you sure you want to cancel this confirmed booking?",X&&(()=>{const e=U.find(e=>e.id===X.id);return e&&e.totalPrice>0?n.jsxs("div",{className:"mt-2 p-3 bg-muted rounded-md",children:[n.jsx("p",{className:"text-sm font-medium",children:"Refund Information:"}),n.jsxs("p",{className:"text-sm text-muted-foreground",children:["A refund of ",l(e.totalPrice)," will be credited to the guest's wallet balance."]})]}):null})()]})]}),n.jsxs(B,{children:[n.jsx(C,{onClick:()=>Z(null),children:"Keep Booking"}),n.jsx(I,{onClick:te,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Cancel Booking"})]})]})})]})};export{G as default};
