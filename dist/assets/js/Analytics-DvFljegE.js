import{u as e,r as t,j as s}from"./react-vendor-Ve3SFwKO.js";import{u as i,j as r,C as a,b as n,c as l,e as d,i as o,d as c}from"./index-BnushFQy.js";import{e as m,d as x}from"./firebase-vendor-BC71bXmb.js";import{B as u}from"./BackButton-DohCcac0.js";import{O as h,a8 as g,m as j,t as f}from"./icons-vendor-DD8ZfUKZ.js";import"./utils-vendor-DzY7Ay74.js";import"./maps-vendor-CYGXCXz5.js";import"./ui-vendor-D9RGQy8n.js";const p=()=>{const p=e(),{user:v,userRole:N}=i(),[w,y]=t.useState(!0),[b,R]=t.useState({totalUsers:0,totalHosts:0,totalGuests:0,totalListings:0,totalBookings:0,totalRevenue:0,avgRating:0}),[T,D]=t.useState([]),[A,L]=t.useState([]),[k,C]=t.useState([]),[S,B]=t.useState(0),[H,U]=t.useState(0);t.useEffect(()=>{v&&"admin"===N?F():p("/admin/login")},[v,N,p]);const F=async()=>{y(!0);try{const[e,t,s,i]=await Promise.all([m(x(r,"users")),m(x(r,"listing")),m(x(r,"bookings")),m(x(r,"reviews"))]),a=e.docs.map(e=>e.data()),n=a.filter(e=>"host"===e.role||e.roles&&Array.isArray(e.roles)&&e.roles.includes("host")).length,l=a.filter(e=>"guest"===e.role||e.roles&&Array.isArray(e.roles)&&e.roles.includes("guest")).length,d=t.docs.map(e=>({id:e.id,...e.data()})).filter(e=>"approved"===e.status),o=s.docs.map(e=>({id:e.id,...e.data()})).filter(e=>"confirmed"===e.status||"completed"===e.status),c=i.docs.map(e=>({id:e.id,...e.data()})),u=(await m(x(r,"transactions"))).docs.map(e=>e.data()).filter(e=>(e.description?.toLowerCase().includes("host subscription")||e.description?.toLowerCase().includes("subscription"))&&"completed"===e.status),h=u.reduce((e,t)=>e+(t.amount||0),0),g=c.length>0?c.reduce((e,t)=>e+t.rating,0)/c.length:0,j=new Map;c.forEach(e=>{const t=j.get(e.listingId)||{totalRating:0,count:0};j.set(e.listingId,{totalRating:t.totalRating+e.rating,count:t.count+1})});const f=Array.from(j.entries()).map(([e,t])=>{const s=d.find(t=>t.id===e);return s?{id:e,title:s.title,rating:t.totalRating/t.count,reviewCount:t.count,price:s.price}:null}).filter(e=>null!==e).sort((e,t)=>t.rating!==e.rating?t.rating-e.rating:t.reviewCount-e.reviewCount).slice(0,3);D(f);const p=Array.from(j.entries()).map(([e,t])=>{const s=d.find(t=>t.id===e);return s?{id:e,title:s.title,rating:t.totalRating/t.count,reviewCount:t.count,price:s.price}:null}).filter(e=>null!==e).sort((e,t)=>e.rating!==t.rating?e.rating-t.rating:t.reviewCount-e.reviewCount).slice(0,3);L(p);const v=new Date,N=new Date(v.getTime()-2592e6),w=[],y=u,b=Math.max(...y.map(e=>e.amount||0),1);for(let r=0;4>r;r++){const e=new Date(N);e.setDate(e.getDate()+7*r),e.setHours(0,0,0,0);const t=new Date(e);t.setDate(t.getDate()+7),t.setHours(0,0,0,0);const s=y.filter(s=>{const i=new Date(s.createdAt);return i.setHours(0,0,0,0),i>=e&&t>i}).reduce((e,t)=>e+(t.amount||0),0),i=b>0?s/b*100:0;w.push({week:"Week "+(r+1),revenue:s,percentage:Math.min(i,100)})}C(w);const T=o.filter(e=>{const t=new Date(e.createdAt),s=(v.getTime()-t.getTime())/864e5;return 30>=s&&s>15}).length,A=o.filter(e=>{const t=new Date(e.createdAt);return 15>=(v.getTime()-t.getTime())/864e5}).length,k=T>0?(A-T)/T*100:0,S=d.filter(e=>{const t=new Date(e.createdAt),s=(v.getTime()-t.getTime())/864e5;return 30>=s&&s>15}).length,H=d.filter(e=>{const t=new Date(e.createdAt);return 15>=(v.getTime()-t.getTime())/864e5}).length,F=S>0?(H-S)/S*100:0;R({totalUsers:e.size,totalHosts:n,totalGuests:l,totalListings:d.length,totalBookings:o.length,totalRevenue:h,avgRating:g}),B(F),U(k)}catch(e){}finally{y(!1)}},G=e=>{const t=0>e?"":"+",i=0>e?"text-red-600":"text-green-600",r=0>e?g:f;return s.jsxs("div",{className:`flex items-center text-xs ${i} mt-1`,children:[s.jsx(r,{className:"h-3 w-3 mr-1"}),t,e.toFixed(1),"% from last period"]})};return w?s.jsx("div",{className:"min-h-screen bg-background p-6 flex items-center justify-center",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),s.jsx("p",{className:"text-muted-foreground",children:"Loading analytics..."})]})}):s.jsx("div",{className:"min-h-screen bg-background p-6",children:s.jsxs("div",{className:"max-w-7xl mx-auto",children:[s.jsx(u,{to:"/admin/dashboard",className:"mb-6"}),s.jsx("h1",{className:"text-3xl font-bold mb-6",children:"Platform Analytics"}),s.jsxs("div",{className:"grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8",children:[s.jsxs(a,{children:[s.jsx(n,{children:s.jsx(l,{className:"text-sm text-muted-foreground",children:"Total Users"})}),s.jsxs(d,{children:[s.jsx("div",{className:"text-3xl font-bold",children:b.totalUsers}),s.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[b.totalHosts," hosts, ",b.totalGuests," guests"]})]})]}),s.jsxs(a,{children:[s.jsx(n,{children:s.jsx(l,{className:"text-sm text-muted-foreground",children:"Total Listings"})}),s.jsxs(d,{children:[s.jsx("div",{className:"text-3xl font-bold",children:b.totalListings}),G(S)]})]}),s.jsxs(a,{children:[s.jsx(n,{children:s.jsx(l,{className:"text-sm text-muted-foreground",children:"Total Bookings"})}),s.jsxs(d,{children:[s.jsx("div",{className:"text-3xl font-bold",children:b.totalBookings}),G(H)]})]}),s.jsxs(a,{children:[s.jsx(n,{children:s.jsx(l,{className:"text-sm text-muted-foreground",children:"Platform Revenue"})}),s.jsxs(d,{children:[s.jsx("div",{className:"text-3xl font-bold text-accent",children:o(b.totalRevenue)}),s.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Subscription revenue"})]})]})]}),s.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[s.jsxs(a,{children:[s.jsxs(n,{children:[s.jsx(l,{children:"Top Rated Listings"}),s.jsx(c,{children:"Highest performing listings"})]}),s.jsx(d,{children:0===T.length?s.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[s.jsx(h,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),s.jsx("p",{children:"No reviews yet"})]}):s.jsx("div",{className:"space-y-4",children:T.map((e,t)=>s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:e.title}),s.jsxs("div",{className:"flex items-center text-sm text-muted-foreground",children:[s.jsx(h,{className:"h-3 w-3 fill-yellow-400 text-yellow-400 mr-1"}),e.rating.toFixed(1)," (",e.reviewCount," reviews)"]})]}),s.jsxs("div",{className:"text-sm text-muted-foreground",children:[o(e.price),"/night"]})]},e.id))})})]}),s.jsxs(a,{children:[s.jsxs(n,{children:[s.jsx(l,{children:"Lowest Rated Listings"}),s.jsx(c,{children:"Listings needing attention"})]}),s.jsx(d,{children:0===A.length?s.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[s.jsx(g,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),s.jsx("p",{children:"No reviews yet"})]}):s.jsx("div",{className:"space-y-4",children:A.map(e=>s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:e.title}),s.jsxs("div",{className:"flex items-center text-sm text-muted-foreground",children:[s.jsx(h,{className:"h-3 w-3 fill-yellow-400 text-yellow-400 mr-1"}),e.rating.toFixed(1)," (",e.reviewCount," reviews)"]})]}),s.jsxs("div",{className:"text-sm text-muted-foreground",children:[o(e.price),"/night"]})]},e.id))})})]}),s.jsxs(a,{children:[s.jsxs(n,{children:[s.jsx(l,{children:"Revenue Trends"}),s.jsx(c,{children:"Last 30 days performance"})]}),s.jsx(d,{children:0===k.length?s.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[s.jsx(j,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),s.jsx("p",{children:"No revenue data yet"})]}):s.jsx("div",{className:"space-y-4",children:k.map((e,t)=>s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm",children:e.week}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-32 bg-muted rounded-full h-2",children:s.jsx("div",{className:"bg-primary h-2 rounded-full",style:{width:e.percentage+"%"}})}),s.jsx("span",{className:"text-sm font-medium",children:o(e.revenue)})]})]},t))})})]})]})]})})};export{p as default};
