import{u as e,r as s,j as t}from"./react-vendor-DcULH_Au.js";import{u as n,B as i,s as o,C as a,d as c,a as r,b as d,i as l,e as u,h as m,j as h,x as f,y as g}from"./index-F95ZJi6y.js";import{a as x,p as j}from"./paymentService-ONRQC2py.js";import{B as p}from"./badge-BPytCQbI.js";import{T as k}from"./theme-toggle-CJqSL7LK.js";import{A as b,a as w,b as v,c as y,d as N,e as B,f as C,g as I}from"./alert-dialog-Ce5W9-KF.js";import{q as P,w as D,c as S,k as A,f as z,e as T,d as O}from"./firebase-vendor-BtzXZj7S.js";import{A as q,i as R,R as E,X as F}from"./icons-vendor-D18eSOBA.js";import"./utils-vendor-yBsXXcRr.js";import"./maps-vendor-CYGXCXz5.js";import"./ui-vendor-C9dhA_ey.js";import"./dropdown-menu-C4xHPRIa.js";const G=()=>{const G=e(),{user:L}=n(),[M,U]=s.useState([]),[$,J]=s.useState(!0),[K,W]=s.useState(!1),[X,Y]=s.useState(!1),[H,Q]=s.useState(!1),[V,Z]=s.useState(null);s.useEffect(()=>{if(!L)return;J(!0);const e=P(S(h,"bookings"),D("hostId","==",L.uid)),s=A(e,e=>{const s=e.docs.map(e=>{const s=e.data();return{id:e.id,...s}});s.sort((e,s)=>{const t=new Date(e.createdAt||0).getTime();return new Date(s.createdAt||0).getTime()-t});const t=s.filter(e=>{const s=e.hostId+""==L.uid+"";return!s&&e.hostId,s});U(t),J(!1),0===t.length&&s.length,0===t.length&&(_(L.uid),ee(L.uid))},e=>{J(!1),u.error("Failed to load bookings: "+(e.message||"Unknown error")),se()});return()=>s()},[L]);const _=async e=>{try{const s=P(S(h,"bookings"));(await O(s)).docs.map(e=>({id:e.id,...e.data()})).filter(s=>s.hostId+""==e+"").length}catch(s){s.code}},ee=async e=>{try{const s=P(S(h,"bookings"),D("hostId","==",e));(await O(s)).docs.map(e=>({id:e.id,...e.data()}))}catch(s){s.code}},se=async()=>{if(L)try{const e=await m({hostId:L.uid});U(e)}catch(e){u.error("Failed to load bookings: "+(e.message||"Unknown error"))}},te=(e,s)=>{if(Z({id:e,action:s}),"confirmed"===s)W(!0);else{const s=M.find(s=>s.id===e);"confirmed"===s?.status?Q(!0):Y(!0)}},ne=async()=>{if(V)try{const a=await z(T(h,"bookings",V.id));if(!a.exists())return void u.error("Booking not found");const c={id:a.id,...a.data()},r=c.status;if(await f(V.id,{status:V.action}),"confirmed"===V.action&&"confirmed"!==r)try{let t;try{t=await x(c,"wallet")}catch(e){if(!e.message?.includes("Insufficient wallet balance"))throw e;try{t=await x(c,"paypal")}catch(s){return await f(V.id,{status:r}),void u.error("Payment failed: Guest has insufficient wallet balance. They need to complete PayPal payment first.")}}if(!t.success)throw Error("Payment processing failed");u.success(`Booking confirmed! Payment of ${l(c.totalPrice||0)} processed.`)}catch(t){return await f(V.id,{status:r}),void u.error("Payment failed: "+(t.message||"Insufficient balance or processing error"))}if("cancelled"===V.action&&"confirmed"===r)try{const e=await j(c,"host");if(!e.success)throw Error("Refund processing failed");u.success(`Booking cancelled. ${l(e.refundAmount||0)} has been refunded to guest's wallet.`)}catch(n){u.warning("Booking cancelled, but refund could not be processed. Please contact support.")}else"cancelled"===V.action&&u.success("Booking cancelled");if("confirmed"===V.action)try{const e=await z(T(h,"bookings",V.id));if(e.exists()){const s=e.data(),t=await z(T(h,"listing",s.listingId));if(t.exists()){const e=t.data();try{const t=await z(T(h,"users",s.guestId));if(t.exists()){const n=t.data();await g(n.email||s.guestId,n.fullName||"Guest",e.title||"Your Booking",e.location||"",s.checkIn,s.checkOut,s.guests||1,s.totalPrice||0,V.id)?u.success("Booking confirmed and confirmation email sent to guest!"):u.warning("Booking confirmed, but email could not be sent. Please check EmailJS configuration.")}else u.warning("Booking confirmed, but guest email not found.")}catch(i){"permission-denied"===i.code?u.error("Permission denied: Cannot access guest information. Please check Firestore rules."):u.warning("Booking confirmed, but could not fetch guest information for email.")}}else u.success("Booking confirmed, but listing details not found.")}else u.success("Booking confirmed, but details not found for email.")}catch(o){u.success("Booking confirmed, but email could not be sent.")}else"cancelled"===V.action&&"confirmed"!==c?.status&&u.success("Booking declined");Z(null)}catch(a){u.error("Failed to update booking")}finally{W(!1),Y(!1),Q(!1)}};return t.jsxs("div",{className:"min-h-screen bg-background",children:[t.jsx("header",{className:"sticky top-0 z-50 border-b bg-card/95 backdrop-blur supports-[backdrop-filter]:bg-card/60 shadow-soft",children:t.jsxs("div",{className:"container mx-auto px-6 py-4 flex justify-between items-center",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(i,{variant:"ghost",size:"icon",onClick:()=>G("/host/dashboard"),children:t.jsx(q,{className:"h-5 w-5"})}),t.jsx("div",{className:"p-2 rounded-lg bg-secondary/10",children:t.jsx(R,{className:"w-5 h-5 text-secondary"})}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-lg font-bold",children:"Booking Requests"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Manage reservations"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(i,{variant:"ghost",size:"icon",onClick:()=>{se()},title:"Refresh bookings",children:t.jsx(E,{className:"h-5 w-5"})}),t.jsx(k,{})]})]})}),t.jsx("div",{className:"max-w-6xl mx-auto p-6",children:$?t.jsx(o,{}):0===M.length?t.jsx(a,{children:t.jsxs(c,{className:"py-12 text-center",children:[t.jsx("p",{className:"text-muted-foreground mb-4",children:"No booking requests"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Bookings will appear here when guests make reservation requests for your listings."}),t.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Current host ID: ",L?.uid]})]})}):t.jsx("div",{className:"grid gap-4",children:M.map(e=>t.jsxs(a,{children:[t.jsx(r,{children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs(d,{children:["Booking #",e.id.slice(0,8)]}),t.jsx(p,{children:e.status})]})}),t.jsx(c,{children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"grid grid-cols-3 gap-4 flex-1",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Check-in"}),t.jsx("p",{className:"font-medium",children:new Date(e.checkIn).toLocaleDateString()})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Check-out"}),t.jsx("p",{className:"font-medium",children:new Date(e.checkOut).toLocaleDateString()})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Total"}),t.jsx("p",{className:"font-medium",children:l(e.totalPrice||0)})]})]}),"pending"===e.status&&t.jsxs("div",{className:"flex gap-2",children:[t.jsx(i,{size:"sm",onClick:()=>te(e.id,"confirmed"),children:"Confirm"}),t.jsx(i,{size:"sm",variant:"destructive",onClick:()=>te(e.id,"cancelled"),children:"Decline"})]}),"confirmed"===e.status&&new Date(e.checkIn)>=new Date&&t.jsx("div",{className:"pt-4 border-t",children:t.jsxs(i,{variant:"destructive",size:"sm",onClick:()=>te(e.id,"cancelled"),className:"w-full",children:[t.jsx(F,{className:"h-4 w-4 mr-2"}),"Cancel Booking"]})})]})})]},e.id))})}),t.jsx(b,{open:K,onOpenChange:W,children:t.jsxs(w,{children:[t.jsxs(v,{children:[t.jsx(y,{children:"Confirm Booking?"}),t.jsx(N,{children:"Are you sure you want to confirm this booking? The guest will be notified and the booking will be finalized."})]}),t.jsxs(B,{children:[t.jsx(C,{onClick:()=>Z(null),children:"Cancel"}),t.jsx(I,{onClick:ne,children:"Confirm Booking"})]})]})}),t.jsx(b,{open:X,onOpenChange:Y,children:t.jsxs(w,{children:[t.jsxs(v,{children:[t.jsx(y,{children:"Decline Booking?"}),t.jsx(N,{children:"Are you sure you want to decline this booking request? The guest will be notified and this action cannot be undone."})]}),t.jsxs(B,{children:[t.jsx(C,{onClick:()=>Z(null),children:"Cancel"}),t.jsx(I,{onClick:ne,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Decline Booking"})]})]})}),t.jsx(b,{open:H,onOpenChange:Q,children:t.jsxs(w,{children:[t.jsxs(v,{children:[t.jsx(y,{children:"Cancel Booking?"}),t.jsxs(N,{children:["Are you sure you want to cancel this confirmed booking?",V&&(()=>{const e=M.find(e=>e.id===V.id);return e&&e.totalPrice>0?t.jsxs("div",{className:"mt-2 p-3 bg-muted rounded-md",children:[t.jsx("p",{className:"text-sm font-medium",children:"Refund Information:"}),t.jsxs("p",{className:"text-sm text-muted-foreground",children:["A refund of ",l(e.totalPrice)," will be credited to the guest's wallet balance."]})]}):null})()]})]}),t.jsxs(B,{children:[t.jsx(C,{onClick:()=>Z(null),children:"Keep Booking"}),t.jsx(I,{onClick:ne,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Cancel Booking"})]})]})})]})};export{G as default};
