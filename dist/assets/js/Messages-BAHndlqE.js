import{l as e,r as s,j as t}from"./react-vendor-BMVo5gto.js";import{u as a,y as r,P as n,Q as c,E as l,e as i,v as o,C as m,a as d,b as p,d as h,B as x}from"./index-BbQqfVom.js";import{I as u}from"./input-B93J7yYR.js";import{S as g}from"./scroll-area-BZ9Ss1y2.js";import{A as f,a as j}from"./avatar-D4-uAIxe.js";import{D as b,a as v,c as w,d as N}from"./dialog-COz4G8V2.js";import{$ as y,a1 as k,a6 as I,X as C,a0 as S}from"./icons-vendor-D1YpcxsO.js";const D=()=>{const{user:D}=a(),[M,A]=e(),[z,E]=s.useState([]),[T,U]=s.useState(""),[L,F]=s.useState(null),[O,P]=s.useState({}),[V,K]=s.useState(!0),[B,Q]=s.useState(!1),[R,$]=s.useState(0),[q,G]=s.useState([]),H=s.useRef(null);s.useEffect(()=>{const e=M.get("userId");e&&e!==L&&(F(e),J(e),M.delete("userId"),A(M,{replace:!0}))},[M,L,A]);const J=async e=>{if(!O[e])try{const s=await r(e);s&&P(t=>({...t,[e]:s.fullName||s.email||"Unknown User"}))}catch(s){}},W=s.useMemo(()=>{if(!D||0===z.length)return[];const e=new Map;return z.forEach(s=>{const t=s.senderId===D.uid?s.receiverId:s.senderId;if(e.has(t)){const a=e.get(t);new Date(s.createdAt)>new Date(a.lastMessage.createdAt)&&(a.lastMessage=s)}else e.set(t,{participantId:t,participantName:O[t]||"Unknown User",lastMessage:s,unreadCount:z.filter(e=>(e.senderId===t||e.receiverId===t)&&e.receiverId===D.uid&&!e.read).length})}),Array.from(e.values()).sort((e,s)=>new Date(s.lastMessage.createdAt).getTime()-new Date(e.lastMessage.createdAt).getTime())},[z,D,O]);s.useEffect(()=>{(async()=>{if(!D||0===W.length)return;const e=[];if(W.forEach(s=>{O[s.participantId]||e.push(s.participantId)}),0===e.length)return;const s={};await Promise.all(e.map(async e=>{const t=await r(e);t&&(s[e]=t.fullName||t.email||"Unknown User")})),Object.keys(s).length>0&&P(e=>({...e,...s}))})()},[W,D]),s.useEffect(()=>{if(!D)return void K(!1);K(!0);const e=n(D.uid,e=>{E(e),K(!1)});return()=>{e()}},[D]);const X=s.useMemo(()=>L&&D?z.filter(e=>e.senderId===L&&e.receiverId===D.uid||e.senderId===D.uid&&e.receiverId===L).sort((e,s)=>new Date(e.createdAt).getTime()-new Date(s.createdAt).getTime()):[],[z,L,D]),Y=L?O[L]||"Loading...":null;s.useEffect(()=>{L&&D&&c(D.uid,L).catch(e=>{})},[L,D]),s.useEffect(()=>{H.current&&H.current.scrollIntoView({behavior:"smooth"})},[X]);const Z=s.useCallback(e=>{const s=[],t=/(https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp|bmp|svg))/gi;return e.forEach(e=>{const a=e.content.match(t);a&&s.push(...a)}),s},[]),_=s.useCallback(async()=>{if(D&&L&&T.trim())try{await l({senderId:D.uid,receiverId:L,content:T.trim(),read:!1}),U(""),i.success("Message sent")}catch(e){i.error("Failed to send message")}},[D,L,T]);return V?t.jsx(o,{}):t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 h-[calc(100vh-120px)] sm:h-[600px]",children:[t.jsxs(m,{className:L?"hidden md:block md:col-span-1":"col-span-1",children:[t.jsx(d,{className:"px-4 sm:px-6 pt-4 sm:pt-6 pb-3 sm:pb-4",children:t.jsx(p,{className:"text-base sm:text-lg",children:"Conversations"})}),t.jsx(h,{className:"p-0",children:t.jsx(g,{className:"h-[calc(100vh-200px)] sm:h-[500px]",children:0===W.length?t.jsx("p",{className:"text-center text-muted-foreground p-4",children:"No conversations yet"}):W.map(e=>t.jsx("div",{className:"p-3 sm:p-4 border-b cursor-pointer hover:bg-accent active:bg-accent transition-colors touch-manipulation "+(L===e.participantId?"bg-accent":""),onClick:()=>{F(e.participantId),O[e.participantId]||J(e.participantId)},children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(f,{children:t.jsx(j,{children:e.participantName.charAt(0).toUpperCase()})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsx("p",{className:"font-medium text-sm truncate",children:e.participantName}),e.unreadCount>0&&t.jsx("span",{className:"bg-primary text-primary-foreground text-xs rounded-full px-2 py-0.5 min-w-[20px] text-center",children:e.unreadCount})]}),t.jsx("p",{className:"text-xs text-muted-foreground line-clamp-1",children:e.lastMessage.content}),t.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:new Date(e.lastMessage.createdAt).toLocaleDateString()===(new Date).toLocaleDateString()?new Date(e.lastMessage.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):new Date(e.lastMessage.createdAt).toLocaleDateString()})]})]})},e.participantId))})})]}),t.jsxs(m,{className:L?"col-span-1 md:col-span-2":"hidden md:block md:col-span-2",children:[t.jsx(d,{className:"px-4 sm:px-6 pt-4 sm:pt-6 pb-3 sm:pb-4",children:t.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[t.jsx(x,{variant:"ghost",size:"icon",className:"md:hidden h-9 w-9 touch-manipulation",onClick:()=>F(null),children:t.jsx(y,{className:"h-4 w-4"})}),t.jsx(p,{className:"text-base sm:text-lg truncate",children:Y?"Chat with "+Y:"Chat"})]})}),t.jsx(h,{className:"px-4 sm:px-6 pb-4 sm:pb-6",children:L?t.jsxs("div",{className:"space-y-4 flex flex-col h-[calc(100vh-240px)] sm:h-[500px]",children:[t.jsx(g,{className:"flex-1 pr-2 sm:pr-4",children:0===X.length?t.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:"No messages yet. Start the conversation!"}):t.jsxs("div",{className:"space-y-4",children:[X.map(e=>{const s=/(https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp|bmp|svg))/gi,a=e.content.match(s),r=e.content.replace(s,"").trim(),n=Z(X);return t.jsx("div",{className:"flex "+(e.senderId===D?.uid?"justify-end":"justify-start"),children:t.jsxs("div",{className:"max-w-[85%] sm:max-w-[70%] rounded-lg p-2.5 sm:p-3 "+(e.senderId===D?.uid?"bg-primary text-primary-foreground":"bg-muted"),children:[r&&t.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:r}),a&&a.length>0&&t.jsx("div",{className:"mt-2 space-y-2",children:a.map((e,s)=>t.jsxs("div",{className:"relative group",children:[t.jsx("img",{src:e,alt:"Image "+(s+1),className:"max-w-full max-h-64 rounded-lg cursor-pointer hover:opacity-90 transition-opacity object-cover",onClick:()=>((e,s)=>{const t=s.indexOf(e);G(s),$(0>t?0:t),Q(!0)})(e,n)}),t.jsxs("div",{className:"absolute top-2 right-2 bg-black/70 text-white px-2 py-1 rounded-full text-xs font-medium backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity",children:[t.jsx(k,{className:"h-3 w-3 inline mr-1"}),"Click to zoom"]})]},s))}),t.jsx("p",{className:"text-xs mt-1 "+(e.senderId===D?.uid?"opacity-70":"text-muted-foreground"),children:new Date(e.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},e.id)}),t.jsx("div",{ref:H})]})}),t.jsxs("div",{className:"flex gap-2 pt-2 sm:pt-3 border-t",children:[t.jsx(u,{placeholder:"Type a message...",value:T,onChange:e=>U(e.target.value),className:"h-11 sm:h-auto text-base sm:text-sm",onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),_())}}),t.jsxs(x,{onClick:_,disabled:!T.trim(),className:"flex items-center gap-2 h-11 sm:h-auto px-4 sm:px-6 touch-manipulation",children:[t.jsx(I,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden sm:inline",children:"Send"})]})]})]}):t.jsx("div",{className:"h-[500px] flex items-center justify-center text-muted-foreground",children:"Select a conversation to start chatting"})})]}),t.jsx(b,{open:B,onOpenChange:Q,children:t.jsxs(v,{className:"max-w-[98vw] max-h-[98vh] w-auto h-auto p-0 bg-black/95 border-none m-1",children:[t.jsx(w,{className:"sr-only",children:"View Full Size Image"}),t.jsxs(N,{className:"sr-only",children:["Viewing image ",R+1," of ",q.length]}),t.jsx("div",{className:"relative w-full h-full flex items-center justify-center min-h-[400px]",children:q.length>0&&t.jsxs(t.Fragment,{children:[t.jsx(x,{variant:"ghost",size:"icon",className:"absolute top-2 right-2 z-50 bg-black/70 hover:bg-black/90 text-white border-none h-8 w-8 sm:h-10 sm:w-10",onClick:()=>Q(!1),children:t.jsx(C,{className:"h-4 w-4 sm:h-5 sm:w-5"})}),t.jsxs("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 bg-black/70 text-white px-3 py-1.5 rounded-full text-xs sm:text-sm font-medium backdrop-blur-sm z-50",children:[R+1," / ",q.length]}),t.jsx("div",{className:"w-full h-full flex items-center justify-center p-2 sm:p-4 pt-12 pb-20 sm:pb-24",children:t.jsx("img",{src:q[R]||"/placeholder.svg",alt:"Image "+(R+1),className:"max-w-full max-h-[calc(98vh-160px)] object-contain"})}),q.length>1&&t.jsxs(t.Fragment,{children:[t.jsx(x,{variant:"ghost",size:"icon",className:"absolute left-2 sm:left-4 top-1/2 -translate-y-1/2 z-50 bg-black/70 hover:bg-black/90 text-white border-none h-8 w-8 sm:h-12 sm:w-12",onClick:()=>$(e=>0===e?q.length-1:e-1),children:t.jsx(y,{className:"h-4 w-4 sm:h-6 sm:w-6"})}),t.jsx(x,{variant:"ghost",size:"icon",className:"absolute right-2 sm:right-4 top-1/2 -translate-y-1/2 z-50 bg-black/70 hover:bg-black/90 text-white border-none h-8 w-8 sm:h-12 sm:w-12",onClick:()=>$(e=>e===q.length-1?0:e+1),children:t.jsx(S,{className:"h-4 w-4 sm:h-6 sm:w-6"})})]}),q.length>1&&t.jsx("div",{className:"absolute bottom-2 sm:bottom-4 left-1/2 -translate-x-1/2 bg-black/70 backdrop-blur-sm rounded-lg p-2 sm:p-3 z-50 max-w-[calc(98vw-32px)]",children:t.jsx("div",{className:"flex gap-2 sm:gap-3 overflow-x-auto scrollbar-hide px-1",children:q.map((e,s)=>t.jsx("button",{onClick:()=>$(s),className:"relative flex-shrink-0 w-12 h-12 sm:w-16 sm:h-16 rounded transition-all "+(R===s?"scale-110 shadow-lg shadow-primary/50":"opacity-70 hover:opacity-100"),children:t.jsx("div",{className:"absolute inset-0 rounded overflow-hidden border-2 "+(R===s?"border-primary ring-2 ring-primary/50 ring-offset-2 ring-offset-black/70":"border-transparent hover:border-white/50"),children:t.jsx("img",{src:e,alt:"Thumbnail "+(s+1),className:"w-full h-full object-cover transition-opacity "+(R===s?"opacity-100":"opacity-70")})})},s))})})]})})]})})]})};export{D as M};
