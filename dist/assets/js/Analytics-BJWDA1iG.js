import{u as e,r as t,j as s}from"./react-vendor-Ve3SFwKO.js";import{u as a,j as i,C as r,a as n,b as l,d,i as c,c as o}from"./index-DaMaslBo.js";import{e as m,d as x,q as u,w as h}from"./firebase-vendor-BC71bXmb.js";import{B as g}from"./BackButton-uEV41aeK.js";import{O as j,a8 as f,m as p,t as v}from"./icons-vendor-Dhca6XHc.js";import"./utils-vendor-DzY7Ay74.js";import"./maps-vendor-CYGXCXz5.js";import"./ui-vendor-D9RGQy8n.js";const N=()=>{const N=e(),{user:w,userRole:y}=a(),[b,D]=t.useState(!0),[R,T]=t.useState({totalUsers:0,totalHosts:0,totalGuests:0,totalListings:0,totalBookings:0,totalRevenue:0,avgRating:0}),[k,A]=t.useState([]),[L,C]=t.useState([]),[B,S]=t.useState([]),[H,F]=t.useState(0),[M,U]=t.useState(0);t.useEffect(()=>{w&&"admin"===y?G():N("/admin/login")},[w,y,N]);const G=async()=>{D(!0);try{const[e,t,s,a,r]=await Promise.all([m(x(i,"users")),m(x(i,"listing")),m(x(i,"bookings")),m(x(i,"reviews")),m(u(x(i,"transactions"),h("paymentMethod","==","service_fee")))]),n=e.docs.map(e=>e.data()),l=n.filter(e=>"host"===e.role||e.roles&&Array.isArray(e.roles)&&e.roles.includes("host")).length,d=n.filter(e=>"guest"===e.role||e.roles&&Array.isArray(e.roles)&&e.roles.includes("guest")).length,c=t.docs.map(e=>({id:e.id,...e.data()})).filter(e=>"approved"===e.status),o=s.docs.map(e=>({id:e.id,...e.data()})),g=a.docs.map(e=>({id:e.id,...e.data()})),j=r.docs.map(e=>({id:e.id,...e.data()})).filter(e=>"completed"===e.status||"pending"===e.status),f=j.reduce((e,t)=>e+(t.amount||0),0),p=o.filter(e=>"confirmed"===e.status||"completed"===e.status),v=g.length>0?g.reduce((e,t)=>e+t.rating,0)/g.length:0,N=new Map;g.forEach(e=>{const t=N.get(e.listingId)||{totalRating:0,count:0};N.set(e.listingId,{totalRating:t.totalRating+e.rating,count:t.count+1})});const w=Array.from(N.entries()).map(([e,t])=>{const s=c.find(t=>t.id===e);return s?{id:e,title:s.title,rating:t.totalRating/t.count,reviewCount:t.count,price:s.price}:null}).filter(e=>null!==e).sort((e,t)=>t.rating!==e.rating?t.rating-e.rating:t.reviewCount-e.reviewCount).slice(0,3);A(w);const y=Array.from(N.entries()).map(([e,t])=>{const s=c.find(t=>t.id===e);return s?{id:e,title:s.title,rating:t.totalRating/t.count,reviewCount:t.count,price:s.price}:null}).filter(e=>null!==e).sort((e,t)=>e.rating!==t.rating?e.rating-t.rating:t.reviewCount-e.reviewCount).slice(0,3);C(y);const b=new Date,D=new Date(b.getTime()-2592e6),R=[],k=Math.max(...j.map(e=>e.amount||0),1);for(let i=0;4>i;i++){const e=new Date(D);e.setDate(e.getDate()+7*i),e.setHours(0,0,0,0);const t=new Date(e);t.setDate(t.getDate()+7),t.setHours(0,0,0,0);const s=j.filter(s=>{const a=new Date(s.createdAt);return a.setHours(0,0,0,0),a>=e&&t>a}).reduce((e,t)=>e+(t.amount||0),0),a=k>0?s/k*100:0;R.push({week:"Week "+(i+1),revenue:s,percentage:Math.min(a,100)})}S(R);const L=p.filter(e=>{const t=new Date(e.createdAt),s=(b.getTime()-t.getTime())/864e5;return 30>=s&&s>15}).length,B=p.filter(e=>{const t=new Date(e.createdAt);return 15>=(b.getTime()-t.getTime())/864e5}).length,H=L>0?(B-L)/L*100:0,M=c.filter(e=>{const t=new Date(e.createdAt),s=(b.getTime()-t.getTime())/864e5;return 30>=s&&s>15}).length,G=c.filter(e=>{const t=new Date(e.createdAt);return 15>=(b.getTime()-t.getTime())/864e5}).length,z=M>0?(G-M)/M*100:0;T({totalUsers:e.size,totalHosts:l,totalGuests:d,totalListings:c.length,totalBookings:s.size,totalRevenue:f,avgRating:v}),F(z),U(H)}catch(e){}finally{D(!1)}},z=e=>{const t=0>e?"":"+",a=0>e?"text-red-600":"text-green-600",i=0>e?f:v;return s.jsxs("div",{className:`flex items-center text-xs ${a} mt-1`,children:[s.jsx(i,{className:"h-3 w-3 mr-1"}),t,e.toFixed(1),"% from last period"]})};return b?s.jsx("div",{className:"min-h-screen bg-background p-6 flex items-center justify-center",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),s.jsx("p",{className:"text-muted-foreground",children:"Loading analytics..."})]})}):s.jsx("div",{className:"min-h-screen bg-background p-6",children:s.jsxs("div",{className:"max-w-7xl mx-auto",children:[s.jsx(g,{to:"/admin/dashboard",label:"Back to Dashboard",className:"mb-6"}),s.jsx("h1",{className:"text-3xl font-bold mb-6",children:"Platform Analytics"}),s.jsxs("div",{className:"grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8",children:[s.jsxs(r,{children:[s.jsx(n,{children:s.jsx(l,{className:"text-sm text-muted-foreground",children:"Total Users"})}),s.jsxs(d,{children:[s.jsx("div",{className:"text-3xl font-bold",children:R.totalUsers}),s.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[R.totalHosts," hosts, ",R.totalGuests," guests"]})]})]}),s.jsxs(r,{children:[s.jsx(n,{children:s.jsx(l,{className:"text-sm text-muted-foreground",children:"Total Listings"})}),s.jsxs(d,{children:[s.jsx("div",{className:"text-3xl font-bold",children:R.totalListings}),z(H)]})]}),s.jsxs(r,{children:[s.jsx(n,{children:s.jsx(l,{className:"text-sm text-muted-foreground",children:"Total Bookings"})}),s.jsxs(d,{children:[s.jsx("div",{className:"text-3xl font-bold",children:R.totalBookings}),z(M)]})]}),s.jsxs(r,{children:[s.jsx(n,{children:s.jsx(l,{className:"text-sm text-muted-foreground",children:"Service Fees"})}),s.jsxs(d,{children:[s.jsx("div",{className:"text-3xl font-bold text-accent",children:c(R.totalRevenue)}),s.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"10% commission"})]})]})]}),s.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[s.jsxs(r,{children:[s.jsxs(n,{children:[s.jsx(l,{children:"Top Rated Listings"}),s.jsx(o,{children:"Highest performing listings"})]}),s.jsx(d,{children:0===k.length?s.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[s.jsx(j,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),s.jsx("p",{children:"No reviews yet"})]}):s.jsx("div",{className:"space-y-4",children:k.map((e,t)=>s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:e.title}),s.jsxs("div",{className:"flex items-center text-sm text-muted-foreground",children:[s.jsx(j,{className:"h-3 w-3 fill-yellow-400 text-yellow-400 mr-1"}),e.rating.toFixed(1)," (",e.reviewCount," reviews)"]})]}),s.jsxs("div",{className:"text-sm text-muted-foreground",children:[c(e.price),"/night"]})]},e.id))})})]}),s.jsxs(r,{children:[s.jsxs(n,{children:[s.jsx(l,{children:"Lowest Rated Listings"}),s.jsx(o,{children:"Listings needing attention"})]}),s.jsx(d,{children:0===L.length?s.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[s.jsx(f,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),s.jsx("p",{children:"No reviews yet"})]}):s.jsx("div",{className:"space-y-4",children:L.map(e=>s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:e.title}),s.jsxs("div",{className:"flex items-center text-sm text-muted-foreground",children:[s.jsx(j,{className:"h-3 w-3 fill-yellow-400 text-yellow-400 mr-1"}),e.rating.toFixed(1)," (",e.reviewCount," reviews)"]})]}),s.jsxs("div",{className:"text-sm text-muted-foreground",children:[c(e.price),"/night"]})]},e.id))})})]}),s.jsxs(r,{children:[s.jsxs(n,{children:[s.jsx(l,{children:"Revenue Trends"}),s.jsx(o,{children:"Last 30 days performance"})]}),s.jsx(d,{children:0===B.length?s.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[s.jsx(p,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),s.jsx("p",{children:"No revenue data yet"})]}):s.jsx("div",{className:"space-y-4",children:B.map((e,t)=>s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm",children:e.week}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-32 bg-muted rounded-full h-2",children:s.jsx("div",{className:"bg-primary h-2 rounded-full",style:{width:e.percentage+"%"}})}),s.jsx("span",{className:"text-sm font-medium",children:c(e.revenue)})]})]},t))})})]})]})]})})};export{N as default};
