import{q as t,d as e,o,e as s,k as a,h as n,f as i,u as r}from"./firebase-vendor-BC71bXmb.js";import{j as c,P as d}from"./index-BnushFQy.js";const l=async t=>{try{const o={...t,createdAt:(new Date).toISOString(),notificationSent:!1,status:"active"};return(await a(e(c,"events"),o)).id}catch(o){throw o}},u=async t=>{try{const o=await n(i(c,"events",t));if(!o.exists())throw Error("Event not found");const a={id:o.id,...o.data()};if(a.notificationSent)return;const l=(await s(e(c,"users"))).docs.map(t=>({id:t.id,...t.data()})).filter(t=>{const e=t.roles&&Array.isArray(t.roles)&&t.roles.length>0?t.roles:t.role?[t.role]:[],o=a.targetRoles.some(t=>e.includes(t));return a.targetUserIds&&a.targetUserIds.length>0?o&&a.targetUserIds.includes(t.id):o}).map(async e=>{try{const o=(e.roles&&Array.isArray(e.roles)&&e.roles.length>0?e.roles:e.role?[e.role]:[]).filter(t=>a.targetRoles.includes(t));if("coupon"===a.type&&a.couponCode&&a.couponDiscount){const o=await n(i(c,"users",e.id));if(o.exists()){const s=o.data().coupons||[];if(!s.some(t=>t.code===a.couponCode)){const o={id:`${a.couponCode}-${e.id}`,code:a.couponCode,discount:a.couponDiscount,validUntil:a.couponValidUntil||new Date(Date.now()+2592e6).toISOString(),used:!1,minSpend:a.couponMinSpend,eventId:t};await r(i(c,"users",e.id),{coupons:[...s,o]})}}}const s=o.map(async o=>{await d({userId:e.id,role:o,type:"system",title:a.title,message:a.description,relatedId:t,relatedType:"event",read:!1,priority:"coupon"===a.type?"high":"medium",actionUrl:a.actionUrl||("host"===o?"/host/wallet":"/guest/wallet")})});await Promise.all(s)}catch(o){}});await Promise.all(l),await r(i(c,"events",t),{notificationSent:!0,notificationSentAt:(new Date).toISOString()})}catch(o){throw o}},p=async()=>{try{const a=t(e(c,"events"),o("createdAt","desc"));return(await s(a)).docs.map(t=>({id:t.id,...t.data()}))}catch(a){throw a}};export{l as c,p as g,u as s};
