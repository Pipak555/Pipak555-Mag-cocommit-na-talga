import{u as e,r as s,j as t}from"./react-vendor-BMVo5gto.js";import{u as i,B as n,v as a,C as o,d as c,a as r,b as d,i as l,e as m,h as u,j as h,z as x,A as f,y as g}from"./index-Bl4WVUm9.js";import{a as j,p}from"./paymentService-CmJK1VwK.js";import{B as k}from"./badge-_91-i8yA.js";import{T as b}from"./theme-toggle-Cc0KLt9y.js";import{A as w,a as N,b as v,c as y,d as B,e as C,f as I,g as P}from"./alert-dialog-ChaDevpt.js";import{q as D,w as S,c as A,k as z,f as T,e as R,d as q}from"./firebase-vendor-BtzXZj7S.js";import{A as O,j as E,R as F,o as G,M,l as U,X as L}from"./icons-vendor-BQMxNFbQ.js";import"./utils-vendor-yBsXXcRr.js";import"./maps-vendor-CYGXCXz5.js";import"./ui-vendor-Dbp4DHG_.js";import"./dropdown-menu-CmwzabuV.js";const $=()=>{const $=e(),{user:J}=i(),[K,Y]=s.useState([]),[H,Q]=s.useState(!0),[V,W]=s.useState(!1),[X,Z]=s.useState(!1),[_,ee]=s.useState(!1),[se,te]=s.useState(null),[ie,ne]=s.useState({});s.useEffect(()=>{if(!J)return;Q(!0);const e=D(A(h,"bookings"),S("hostId","==",J.uid)),s=z(e,e=>{const s=e.docs.map(e=>{const s=e.data();return{id:e.id,...s}});s.sort((e,s)=>{const t=new Date(e.createdAt||0).getTime();return new Date(s.createdAt||0).getTime()-t});const t=s.filter(e=>{const s=e.hostId+""==J.uid+"";return!s&&e.hostId,s});Y(t),Q(!1),re(t),0===t.length&&s.length,0===t.length&&(ae(J.uid),oe(J.uid))},e=>{Q(!1),m.error("Failed to load bookings: "+(e.message||"Unknown error")),ce()});return()=>s()},[J]);const ae=async e=>{try{const s=D(A(h,"bookings"));(await q(s)).docs.map(e=>({id:e.id,...e.data()})).filter(s=>s.hostId+""==e+"").length}catch(s){s.code}},oe=async e=>{try{const s=D(A(h,"bookings"),S("hostId","==",e));(await q(s)).docs.map(e=>({id:e.id,...e.data()}))}catch(s){s.code}},ce=async()=>{if(J)try{const e=await u({hostId:J.uid});Y(e),re(e)}catch(e){m.error("Failed to load bookings: "+(e.message||"Unknown error"))}},re=async e=>{const s=[...new Set(e.map(e=>e.guestId).filter(Boolean))],t={};await Promise.all(s.map(async e=>{try{const s=await g(e);s&&(t[e]={fullName:s.fullName,email:s.email})}catch(s){}})),ne(t)},de=(e,s)=>{if(te({id:e,action:s}),"confirmed"===s)W(!0);else{const s=K.find(s=>s.id===e);"confirmed"===s?.status?ee(!0):Z(!0)}},le=async()=>{if(se)try{const o=await T(R(h,"bookings",se.id));if(!o.exists())return void m.error("Booking not found");const c={id:o.id,...o.data()},r=c.status;if(await x(se.id,{status:se.action}),"confirmed"===se.action&&"confirmed"!==r)try{let t;try{t=await j(c,"wallet")}catch(e){if(!e.message?.includes("Insufficient wallet balance"))throw e;try{t=await j(c,"paypal")}catch(s){return await x(se.id,{status:r}),void m.error("Payment failed: Guest has insufficient wallet balance. They need to complete PayPal payment first.")}}if(!t.success)throw Error("Payment processing failed");m.success(`Booking confirmed! Payment of ${l(c.totalPrice||0)} processed.`)}catch(t){return await x(se.id,{status:r}),void m.error("Payment failed: "+(t.message||"Insufficient balance or processing error"))}if("cancelled"===se.action&&"confirmed"===r)try{const e=await p(c,"host");if(!e.success)throw Error("Refund processing failed");m.success(`Booking cancelled. ${l(e.refundAmount||0)} has been refunded to guest's wallet.`)}catch(i){m.warning("Booking cancelled, but refund could not be processed. Please contact support.")}else"cancelled"===se.action&&m.success("Booking cancelled");if("confirmed"===se.action)try{const e=await T(R(h,"bookings",se.id));if(e.exists()){const s=e.data(),t=await T(R(h,"listing",s.listingId));if(t.exists()){const e=t.data();try{const t=await T(R(h,"users",s.guestId));if(t.exists()){const i=t.data();await f(i.email||s.guestId,i.fullName||"Guest",e.title||"Your Booking",e.location||"",s.checkIn,s.checkOut,s.guests||1,s.totalPrice||0,se.id)?m.success("Booking confirmed and confirmation email sent to guest!"):m.warning("Booking confirmed, but email could not be sent. Please check EmailJS configuration.")}else m.warning("Booking confirmed, but guest email not found.")}catch(n){"permission-denied"===n.code?m.error("Permission denied: Cannot access guest information. Please check Firestore rules."):m.warning("Booking confirmed, but could not fetch guest information for email.")}}else m.success("Booking confirmed, but listing details not found.")}else m.success("Booking confirmed, but details not found for email.")}catch(a){m.success("Booking confirmed, but email could not be sent.")}else"cancelled"===se.action&&"confirmed"!==c?.status&&m.success("Booking declined");te(null)}catch(o){m.error("Failed to update booking")}finally{W(!1),Z(!1),ee(!1)}};return t.jsxs("div",{className:"min-h-screen bg-background",children:[t.jsx("header",{className:"sticky top-0 z-50 border-b bg-card/95 backdrop-blur supports-[backdrop-filter]:bg-card/60 shadow-soft",children:t.jsxs("div",{className:"container mx-auto px-6 py-4 flex justify-between items-center",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(n,{variant:"ghost",size:"icon",onClick:()=>$("/host/dashboard"),children:t.jsx(O,{className:"h-5 w-5"})}),t.jsx("div",{className:"p-2 rounded-lg bg-secondary/10",children:t.jsx(E,{className:"w-5 h-5 text-secondary"})}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-lg font-bold",children:"Booking Requests"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Manage reservations"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(n,{variant:"ghost",size:"icon",onClick:()=>{ce()},title:"Refresh bookings",children:t.jsx(F,{className:"h-5 w-5"})}),t.jsx(b,{})]})]})}),t.jsx("div",{className:"max-w-6xl mx-auto p-6",children:H?t.jsx(a,{}):0===K.length?t.jsx(o,{children:t.jsxs(c,{className:"py-12 text-center",children:[t.jsx("p",{className:"text-muted-foreground mb-4",children:"No booking requests"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Bookings will appear here when guests make reservation requests for your listings."}),t.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Current host ID: ",J?.uid]})]})}):t.jsx("div",{className:"grid gap-4",children:K.map(e=>t.jsxs(o,{children:[t.jsx(r,{children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs(d,{children:["Booking #",e.id.slice(0,8)]}),t.jsx(k,{children:e.status})]})}),t.jsx(c,{children:t.jsxs("div",{className:"space-y-4",children:[e.guestId&&ie[e.guestId]&&t.jsx("div",{className:"bg-muted/50 p-3 rounded-lg",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[t.jsx(G,{className:"h-4 w-4 text-muted-foreground"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-sm font-medium",children:ie[e.guestId].fullName||"Guest"}),t.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[t.jsx(M,{className:"h-3 w-3 text-muted-foreground"}),t.jsx("a",{href:"mailto:"+ie[e.guestId].email,className:"text-xs text-primary hover:underline",children:ie[e.guestId].email})]})]})]}),t.jsxs(n,{variant:"outline",size:"sm",onClick:()=>$("/host/messages?userId="+e.guestId),className:"flex items-center gap-2",children:[t.jsx(U,{className:"h-4 w-4"}),"Message"]})]})}),t.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Check-in"}),t.jsx("p",{className:"font-medium",children:new Date(e.checkIn).toLocaleDateString()})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Check-out"}),t.jsx("p",{className:"font-medium",children:new Date(e.checkOut).toLocaleDateString()})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Total"}),t.jsx("p",{className:"font-medium",children:l(e.totalPrice||0)})]})]}),"pending"===e.status&&t.jsxs("div",{className:"flex gap-2 pt-2",children:[t.jsx(n,{size:"sm",onClick:()=>de(e.id,"confirmed"),className:"flex-1",children:"Confirm"}),t.jsx(n,{size:"sm",variant:"destructive",onClick:()=>de(e.id,"cancelled"),className:"flex-1",children:"Decline"})]}),"confirmed"===e.status&&new Date(e.checkIn)>=new Date&&t.jsx("div",{className:"pt-2 border-t",children:t.jsxs(n,{variant:"destructive",size:"sm",onClick:()=>de(e.id,"cancelled"),className:"w-full",children:[t.jsx(L,{className:"h-4 w-4 mr-2"}),"Cancel Booking"]})})]})})]},e.id))})}),t.jsx(w,{open:V,onOpenChange:W,children:t.jsxs(N,{children:[t.jsxs(v,{children:[t.jsx(y,{children:"Confirm Booking?"}),t.jsx(B,{children:"Are you sure you want to confirm this booking? The guest will be notified and the booking will be finalized."})]}),t.jsxs(C,{children:[t.jsx(I,{onClick:()=>te(null),children:"Cancel"}),t.jsx(P,{onClick:le,children:"Confirm Booking"})]})]})}),t.jsx(w,{open:X,onOpenChange:Z,children:t.jsxs(N,{children:[t.jsxs(v,{children:[t.jsx(y,{children:"Decline Booking?"}),t.jsx(B,{children:"Are you sure you want to decline this booking request? The guest will be notified and this action cannot be undone."})]}),t.jsxs(C,{children:[t.jsx(I,{onClick:()=>te(null),children:"Cancel"}),t.jsx(P,{onClick:le,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Decline Booking"})]})]})}),t.jsx(w,{open:_,onOpenChange:ee,children:t.jsxs(N,{children:[t.jsxs(v,{children:[t.jsx(y,{children:"Cancel Booking?"}),t.jsxs(B,{children:["Are you sure you want to cancel this confirmed booking?",se&&(()=>{const e=K.find(e=>e.id===se.id);return e&&e.totalPrice>0?t.jsxs("div",{className:"mt-2 p-3 bg-muted rounded-md",children:[t.jsx("p",{className:"text-sm font-medium",children:"Refund Information:"}),t.jsxs("p",{className:"text-sm text-muted-foreground",children:["A refund of ",l(e.totalPrice)," will be credited to the guest's wallet balance."]})]}):null})()]})]}),t.jsxs(C,{children:[t.jsx(I,{onClick:()=>te(null),children:"Keep Booking"}),t.jsx(P,{onClick:le,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Cancel Booking"})]})]})})]})};export{$ as default};
