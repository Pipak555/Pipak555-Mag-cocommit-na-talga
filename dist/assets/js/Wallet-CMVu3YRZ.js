import{l as e,u as a,r as s,j as t}from"./react-vendor-BMVo5gto.js";import{j as l,e as r,B as i,u as n,D as c,i as o,C as d,a as m,b as p,c as u,d as x}from"./index-Bl4WVUm9.js";import{f as y,e as h,u as b}from"./firebase-vendor-BtzXZj7S.js";import{I as j}from"./input-BUMXIaDj.js";import{L as w}from"./label-CNgDwY3J.js";import{C as g}from"./CouponManager--qRlUom5.js";import{P as f}from"./PayPalButton-BeJKL0tB.js";import{f as P,L as N,C as v,a4 as k,i as S,A as C,r as E,s as A,a5 as I}from"./icons-vendor-BQMxNFbQ.js";import"./utils-vendor-yBsXXcRr.js";import"./maps-vendor-CYGXCXz5.js";import"./ui-vendor-Dbp4DHG_.js";import"./badge-_91-i8yA.js";const V=({userId:n,onVerified:c,paypalEmail:o,paypalVerified:d})=>{const[m]=e(),p=a(),[u,x]=s.useState(!1),[j,w]=s.useState(!1),g=window.location.origin;let f=g+"/paypal-callback";g.includes("localhost")&&(f=f.replace("localhost","127.0.0.1"));const C=s.useCallback(async e=>{w(!0);try{const e=await y(h(l,"users",n)),a=e.exists()?e.data():null,s=a?.paypalEmail||null,t={paypalEmailVerified:!0,paypalVerifiedAt:(new Date).toISOString(),paypalOAuthVerified:!0};s||(t.paypalEmail=null),await b(h(l,"users",n),t),s?(r.success("PayPal account verified! You successfully logged in with PayPal."),c(s)):(r.success("PayPal account verified! Your email will be stored on your first payment."),c("")),p(window.location.pathname,{replace:!0})}catch(a){r.error("Failed to verify PayPal account. Please try again."),p(window.location.pathname,{replace:!0})}finally{w(!1)}},[n,p,c]);return s.useEffect(()=>{const e=m.get("code"),a=m.get("state"),s=m.get("error"),t=m.get("error_description")||"";if(s){if(t.includes("redirect_uri")||t.includes("invalid")||"invalid_client"===s){g.replace(/^https?:\/\//,"").split(":")[0],new URLSearchParams(window.location.search);let e=f;if(t){const a=t.match(/redirect_uri[=:]\s*([^\s&]+)/i);a&&(e=decodeURIComponent(a[1]))}r.error("PayPal configuration error: Redirect URI not registered.",{duration:12e3,description:`PayPal received: "${e}". Add this EXACT URI to PayPal Return URLs.`})}else"access_denied"===s?r.info("PayPal login was cancelled."):r.error(`PayPal login failed: ${t||s}. Please try again.`);p(window.location.pathname,{replace:!0})}else e&&a==="paypal-verify-"+n&&C(e)},[m,n,p,C,f]),d&&o?t.jsx("div",{className:"space-y-4",children:t.jsx("div",{className:"flex items-center justify-between p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(P,{className:"h-5 w-5 text-green-600 dark:text-green-400"}),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium text-green-900 dark:text-green-100",children:"PayPal Account Verified"}),t.jsx("p",{className:"text-sm text-green-700 dark:text-green-300",children:o}),t.jsx("p",{className:"text-xs text-green-600 dark:text-green-400 mt-1",children:"Your account was verified by logging in with PayPal"})]})]})})}):j?t.jsx("div",{className:"space-y-4",children:t.jsx("div",{className:"flex items-center justify-center p-8 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg",children:t.jsxs("div",{className:"text-center",children:[t.jsx(N,{className:"h-8 w-8 text-blue-600 dark:text-blue-400 animate-spin mx-auto mb-3"}),t.jsx("p",{className:"text-sm font-medium text-blue-900 dark:text-blue-100",children:"Verifying PayPal account..."}),t.jsx("p",{className:"text-xs text-blue-700 dark:text-blue-300 mt-2",children:"Please wait while we verify your account"})]})})}):t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center gap-2 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg",children:[t.jsx(v,{className:"h-5 w-5 text-yellow-600 dark:text-yellow-400"}),t.jsx("p",{className:"text-sm text-yellow-900 dark:text-yellow-100",children:"Link your PayPal account to make deposits and payments. You'll log in with your PayPal credentials to verify your account."})]}),t.jsxs("div",{className:"p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg",children:[t.jsx("p",{className:"text-sm font-medium text-blue-900 dark:text-blue-100 mb-2",children:"Don't have a PayPal account?"}),t.jsxs(i,{variant:"outline",size:"sm",onClick:()=>window.open("https://www.paypal.com/signup","_blank"),className:"w-full mb-2",children:[t.jsx(k,{className:"h-4 w-4 mr-2"}),"Sign up for PayPal"]}),t.jsx("p",{className:"text-xs text-blue-700 dark:text-blue-300",children:"Create a free PayPal account, then come back to link it"})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[t.jsx("p",{className:"text-sm font-medium mb-2",children:"How it works:"}),t.jsxs("ol",{className:"text-xs text-muted-foreground space-y-1 list-decimal list-inside",children:[t.jsx("li",{children:'Click "Link PayPal Account" below'}),t.jsx("li",{children:"You'll be redirected to PayPal's login page"}),t.jsx("li",{children:"Log in with your PayPal email and password"}),t.jsx("li",{children:"PayPal will verify your account and redirect you back"}),t.jsx("li",{children:"Your account will be linked and verified âœ…"})]})]}),t.jsx(i,{onClick:()=>{x(!0);const e="paypal-verify-"+n,a=`https://www.sandbox.paypal.com/webapps/auth/protocol/openidconnect/v1/authorize?client_id=EBY2ts8baThwt97plOoNWxeryVxWHXEe-ANWAexRZ7zq1sfq-qIa90XNhC5JExAaFGTvrF_TT2hqwzj0&response_type=code&scope=${encodeURIComponent("openid email profile")}&redirect_uri=${encodeURIComponent(f)}&state=${e}`;window.location.href=a},disabled:u,className:"w-full",size:"lg",children:u?t.jsxs(t.Fragment,{children:[t.jsx(N,{className:"h-4 w-4 mr-2 animate-spin"}),"Redirecting to PayPal..."]}):t.jsxs(t.Fragment,{children:[t.jsx(S,{className:"h-4 w-4 mr-2"}),"Link PayPal Account"]})}),t.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"You'll be redirected to PayPal to log in with your account credentials"})]})]})},_=()=>{const e=a(),{user:P}=n(),[N,k]=s.useState(0),[_,L]=s.useState([]),[R,U]=s.useState([]),[F,T]=s.useState(""),[Y,$]=s.useState(!1),[B,D]=s.useState(""),[z,W]=s.useState(!1),[q,O]=s.useState(!1);s.useEffect(()=>{if(P){X(),J();const e=new URLSearchParams(window.location.search),a=e.get("token"),s=e.get("PayerID");a&&s&&H()}},[P]);const H=async(e,a)=>{const s=sessionStorage.getItem("paypal_pending_order");if(s){JSON.parse(s);try{r.success("Payment successful! Processing..."),await G(),sessionStorage.removeItem("paypal_pending_order"),window.history.replaceState({},"",window.location.pathname)}catch(t){r.error("Payment verification failed. Please contact support.")}}else r.error("Payment session expired. Please try again.")},X=async()=>{if(!P)return;const e=await y(h(l,"users",P.uid));if(e.exists()){const a=e.data();k(a.walletBalance||0),L(a.coupons||[]),D(a.paypalEmail||""),W(!!a.paypalEmail),O(!!a.paypalEmailVerified)}},J=async()=>{if(!P)return;const e=await c(P.uid);U(e)},Z=s.useCallback(e=>{D(e),W(!0),O(!0),X()},[P]),G=async()=>{if(!P)return;await new Promise(e=>setTimeout(e,500)),await X(),await J();const e=F;T(""),r.success(`Successfully deposited ${o(+e)} to your wallet!`);const a=await y(h(l,"users",P.uid));a.exists()&&a.data().paypalEmailVerified&&!q&&O(!0)};return t.jsx("div",{className:"min-h-screen bg-background p-4 sm:p-6",children:t.jsxs("div",{className:"max-w-6xl mx-auto",children:[t.jsxs(i,{variant:"ghost",onClick:()=>e("/guest/dashboard"),className:"mb-4 sm:mb-6 h-10 sm:h-auto",children:[t.jsx(C,{className:"h-4 w-4 mr-2"}),t.jsx("span",{className:"hidden sm:inline",children:"Back to Dashboard"}),t.jsx("span",{className:"sm:hidden",children:"Back"})]}),t.jsx("h1",{className:"text-2xl sm:text-3xl font-bold mb-4 sm:mb-6",children:"E-Wallet"}),t.jsxs(d,{className:"mb-4 sm:mb-6 border-2",children:[t.jsxs(m,{className:"px-4 sm:px-6 pt-4 sm:pt-6 pb-3 sm:pb-4",children:[t.jsxs(p,{className:"flex items-center gap-2 text-base sm:text-lg",children:[t.jsx(S,{className:"h-4 w-4 sm:h-5 sm:w-5"}),"PayPal Account Verification"]}),t.jsx(u,{className:"text-xs sm:text-sm",children:"Link your PayPal account by logging in with your PayPal credentials. This verifies you have a real PayPal account."})]}),t.jsxs(x,{className:"px-4 sm:px-6 pb-4 sm:pb-6",children:[P?t.jsx(V,{userId:P.uid,onVerified:Z,paypalEmail:B,paypalVerified:q}):t.jsx("div",{className:"p-4 bg-muted rounded-lg",children:t.jsx("p",{className:"text-sm text-muted-foreground",children:"Please sign in to verify your PayPal account"})}),q&&B&&t.jsx("div",{className:"mt-4",children:t.jsx(i,{variant:"outline",size:"sm",onClick:async()=>{if(P)try{await b(h(l,"users",P.uid),{paypalEmail:null,paypalEmailVerified:!1,paypalLinkedAt:null}),W(!1),D(""),r.success("PayPal account unlinked")}catch(e){r.error("Failed to unlink PayPal account")}},className:"w-full",children:"Unlink PayPal Account"})})]})]}),t.jsxs(d,{className:"mb-4 sm:mb-6",children:[t.jsx(m,{className:"px-4 sm:px-6 pt-4 sm:pt-6 pb-3 sm:pb-4",children:t.jsxs(p,{className:"flex items-center gap-2 text-base sm:text-lg",children:[t.jsx(E,{className:"h-4 w-4 sm:h-5 sm:w-5"}),"Current Balance"]})}),t.jsxs(x,{className:"px-4 sm:px-6 pb-4 sm:pb-6",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("p",{className:"text-3xl sm:text-4xl font-bold text-primary",children:o(N)}),t.jsx("p",{className:"text-xs sm:text-sm text-muted-foreground mt-1",children:"Available balance"})]}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx(w,{htmlFor:"deposit-amount",className:"text-sm font-medium mb-2 block",children:"Deposit Amount"}),t.jsx(j,{id:"deposit-amount",type:"number",placeholder:"Enter amount",value:F,onChange:e=>T(e.target.value),min:"1",step:"0.01",disabled:!q,className:"h-12 text-base sm:text-sm"})]}),q?P&&F&&+F>0?t.jsxs("div",{className:"space-y-3",children:[t.jsx(f,{amount:+F,userId:P.uid,description:"Wallet deposit: "+o(+F),onSuccess:G,redirectUrl:window.location.origin+"/guest/wallet",useRedirectFlow:!0}),t.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"Secure payment powered by PayPal"})]}):t.jsx(i,{onClick:async()=>{P&&F&&+F>0?B?r.info("Please use PayPal to add funds to your wallet"):r.error("Please link your PayPal account first to make deposits"):r.error("Enter a valid amount")},disabled:!F||0>=+F,className:"w-full h-12",variant:"outline",children:"Enter amount to deposit"}):t.jsx("div",{className:"p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(v,{className:"h-5 w-5 text-yellow-600 dark:text-yellow-400 flex-shrink-0"}),t.jsx("p",{className:"text-sm text-yellow-900 dark:text-yellow-100",children:"Link and verify your PayPal account above to make deposits"})]})})]})]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6",children:[t.jsx(g,{coupons:_,onApplyCoupon:e=>{const a=_.find(a=>a.code===e&&!a.used);a?r.success(`Coupon ${e} applied! ${o(a.discount)} discount`):r.error("Invalid or already used coupon")}}),t.jsxs(d,{children:[t.jsx(m,{className:"px-4 sm:px-6 pt-4 sm:pt-6 pb-3 sm:pb-4",children:t.jsx(p,{className:"text-base sm:text-lg",children:"Transaction History"})}),t.jsx(x,{className:"px-4 sm:px-6 pb-4 sm:pb-6",children:0===R.length?t.jsx("p",{className:"text-center text-muted-foreground py-6 sm:py-8 text-sm sm:text-base",children:"No transactions yet"}):t.jsx("div",{className:"space-y-2 sm:space-y-3",children:R.map(e=>t.jsxs("div",{className:"flex items-center justify-between p-2.5 sm:p-3 border rounded touch-manipulation",children:[t.jsxs("div",{className:"flex items-center gap-3",children:["deposit"===e.type||"reward"===e.type?t.jsx(A,{className:"h-5 w-5 text-green-500"}):t.jsx(I,{className:"h-5 w-5 text-red-500"}),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium",children:e.description}),t.jsx("p",{className:"text-xs text-muted-foreground",children:new Date(e.createdAt).toLocaleString()})]})]}),t.jsxs("p",{className:"font-semibold "+("deposit"===e.type||"reward"===e.type?"text-green-500":"text-red-500"),children:["deposit"===e.type||"reward"===e.type?"+":"-",o(e.amount)]})]},e.id))})})]})]})]})})};export{_ as default};
