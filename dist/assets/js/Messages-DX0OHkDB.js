import{r as e,j as t}from"./react-vendor-DAkY0NgE.js";import{u as s,H as a,I as r,e as n,x as i,C as c,a as d,b as l,d as o,B as m,J as u}from"./index-BbvEjZj9.js";import{I as x}from"./input-C1fDyqub.js";import{S as p}from"./scroll-area-DiLI9L8b.js";import{A as h,a as g}from"./avatar-jgLwWdSB.js";import{a4 as f}from"./icons-vendor-3zhgXMYa.js";const j=()=>{const{user:j}=s(),[v,N]=e.useState([]),[w,y]=e.useState(""),[I,D]=e.useState(null),[b,M]=e.useState({}),[S,A]=e.useState(!0),C=e.useMemo(()=>{if(!j||0===v.length)return[];const e=new Map;return v.forEach(t=>{const s=t.senderId===j.uid?t.receiverId:t.senderId;if(e.has(s)){const a=e.get(s);new Date(t.createdAt)>new Date(a.lastMessage.createdAt)&&(a.lastMessage=t)}else e.set(s,{participantId:s,participantName:b[s]||"Unknown User",lastMessage:t,unreadCount:v.filter(e=>(e.senderId===s||e.receiverId===s)&&e.receiverId===j.uid&&!e.read).length})}),Array.from(e.values()).sort((e,t)=>new Date(t.lastMessage.createdAt).getTime()-new Date(e.lastMessage.createdAt).getTime())},[v,j,b]);e.useEffect(()=>{(async()=>{if(!j||0===C.length)return;const e=[];if(C.forEach(t=>{b[t.participantId]||e.push(t.participantId)}),0===e.length)return;const t={};await Promise.all(e.map(async e=>{const s=await u(e);s&&(t[e]=s.fullName||s.email||"Unknown User")})),Object.keys(t).length>0&&M(e=>({...e,...t}))})()},[C,j]),e.useEffect(()=>{if(!j)return void A(!1);A(!0);const e=a(j.uid,e=>{N(e),A(!1)});return()=>{e()}},[j]);const k=e.useMemo(()=>I&&j?v.filter(e=>e.senderId===I&&e.receiverId===j.uid||e.senderId===j.uid&&e.receiverId===I).sort((e,t)=>new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime()):[],[v,I,j]),T=I?b[I]||"Unknown User":null,U=e.useCallback(async()=>{if(j&&I&&w.trim())try{await r({senderId:j.uid,receiverId:I,content:w.trim(),read:!1}),y(""),n.success("Message sent")}catch(e){n.error("Failed to send message")}},[j,I,w]);return S?t.jsx(i,{}):t.jsxs("div",{className:"grid md:grid-cols-3 gap-4 h-[600px]",children:[t.jsxs(c,{className:"md:col-span-1",children:[t.jsx(d,{children:t.jsx(l,{children:"Conversations"})}),t.jsx(o,{className:"p-0",children:t.jsx(p,{className:"h-[500px]",children:0===C.length?t.jsx("p",{className:"text-center text-muted-foreground p-4",children:"No conversations yet"}):C.map(e=>t.jsx("div",{className:"p-4 border-b cursor-pointer hover:bg-accent transition-colors "+(I===e.participantId?"bg-accent":""),onClick:()=>D(e.participantId),children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(h,{children:t.jsx(g,{children:e.participantName.charAt(0).toUpperCase()})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsx("p",{className:"font-medium text-sm truncate",children:e.participantName}),e.unreadCount>0&&t.jsx("span",{className:"bg-primary text-primary-foreground text-xs rounded-full px-2 py-0.5 min-w-[20px] text-center",children:e.unreadCount})]}),t.jsx("p",{className:"text-xs text-muted-foreground line-clamp-1",children:e.lastMessage.content}),t.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:new Date(e.lastMessage.createdAt).toLocaleDateString()===(new Date).toLocaleDateString()?new Date(e.lastMessage.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):new Date(e.lastMessage.createdAt).toLocaleDateString()})]})]})},e.participantId))})})]}),t.jsxs(c,{className:"md:col-span-2",children:[t.jsx(d,{children:t.jsx(l,{children:T?"Chat with "+T:"Chat"})}),t.jsx(o,{children:I?t.jsxs("div",{className:"space-y-4 flex flex-col h-[500px]",children:[t.jsx(p,{className:"flex-1 pr-4",children:0===k.length?t.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:"No messages yet. Start the conversation!"}):t.jsx("div",{className:"space-y-4",children:k.map(e=>t.jsx("div",{className:"flex "+(e.senderId===j?.uid?"justify-end":"justify-start"),children:t.jsxs("div",{className:"max-w-[70%] rounded-lg p-3 "+(e.senderId===j?.uid?"bg-primary text-primary-foreground":"bg-muted"),children:[t.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:e.content}),t.jsx("p",{className:"text-xs mt-1 "+(e.senderId===j?.uid?"opacity-70":"text-muted-foreground"),children:new Date(e.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},e.id))})}),t.jsxs("div",{className:"flex gap-2 pt-2 border-t",children:[t.jsx(x,{placeholder:"Type a message...",value:w,onChange:e=>y(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),U())}}),t.jsx(m,{onClick:U,disabled:!w.trim(),children:t.jsx(f,{className:"h-4 w-4"})})]})]}):t.jsx("div",{className:"h-[500px] flex items-center justify-center text-muted-foreground",children:"Select a conversation to start chatting"})})]})]})};export{j as M};
