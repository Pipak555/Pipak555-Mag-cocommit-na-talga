import{u as e,r as s,j as t}from"./react-vendor-Ve3SFwKO.js";import{u as n,B as i,v as a,C as o,e as c,b as r,c as l,i as d,a as u,h as m,j as h,D as g,E as x,A as f}from"./index-BnushFQy.js";import{a as j,p}from"./paymentService-6NJnvF44.js";import{B as k}from"./badge-CYghlWc2.js";import{T as w}from"./theme-toggle-C_syTt2a.js";import{A as b,a as N,b as v,c as y,d as B,e as C,f as I,g as D}from"./alert-dialog-Bv7bA0QL.js";import{q as P,w as S,d as A,l as q,h as z,f as O,e as T}from"./firebase-vendor-BC71bXmb.js";import{A as E,j as R,R as F,o as G,M as H,l as M,X as L}from"./icons-vendor-DD8ZfUKZ.js";import"./utils-vendor-DzY7Ay74.js";import"./maps-vendor-CYGXCXz5.js";import"./ui-vendor-D9RGQy8n.js";import"./dropdown-menu-eYIb6UEc.js";const U=()=>{const U=e(),{user:Y}=n(),[$,J]=s.useState([]),[K,V]=s.useState(!0),[Q,W]=s.useState(!1),[X,Z]=s.useState(!1),[_,ee]=s.useState(!1),[se,te]=s.useState(null),[ne,ie]=s.useState({});s.useEffect(()=>{if(!Y)return;V(!0);const e=P(A(h,"bookings"),S("hostId","==",Y.uid)),s=q(e,e=>{const s=e.docs.map(e=>{const s=e.data();return{id:e.id,...s}});s.sort((e,s)=>{const t=new Date(e.createdAt||0).getTime();return new Date(s.createdAt||0).getTime()-t});const t=s.filter(e=>{const s=e.hostId+""==Y.uid+"";return!s&&e.hostId,s});J(t),V(!1),re(t),0===t.length&&s.length,0===t.length&&(ae(Y.uid),oe(Y.uid))},e=>{V(!1),u.error("Failed to load bookings: "+(e.message||"Unknown error")),ce()});return()=>s()},[Y]);const ae=async e=>{try{const s=P(A(h,"bookings"));(await T(s)).docs.map(e=>({id:e.id,...e.data()})).filter(s=>s.hostId+""==e+"").length}catch(s){s.code}},oe=async e=>{try{const s=P(A(h,"bookings"),S("hostId","==",e));(await T(s)).docs.map(e=>({id:e.id,...e.data()}))}catch(s){s.code}},ce=async()=>{if(Y)try{const e=await m({hostId:Y.uid});J(e),re(e)}catch(e){u.error("Failed to load bookings: "+(e.message||"Unknown error"))}},re=async e=>{const s=[...new Set(e.map(e=>e.guestId).filter(Boolean))],t={};await Promise.all(s.map(async e=>{try{const s=await f(e);s&&(t[e]={fullName:s.fullName,email:s.email})}catch(s){}})),ie(t)},le=(e,s)=>{if(te({id:e,action:s}),"confirmed"===s)W(!0);else{const s=$.find(s=>s.id===e);"confirmed"===s?.status?ee(!0):Z(!0)}},de=async()=>{if(se)try{const c=await z(O(h,"bookings",se.id));if(!c.exists())return void u.error("Booking not found");const r={id:c.id,...c.data()},l=r.status;if(await g(se.id,{status:se.action}),"confirmed"===se.action&&"confirmed"!==l)try{let n;try{n=await j(r,"wallet")}catch(e){if(!e.message?.includes("Insufficient wallet balance"))throw e;try{n=await j(r,"paypal")}catch(s){return await g(se.id,{status:l}),void u.error("Payment failed: Guest has insufficient wallet balance. They need to complete PayPal payment first.")}}if(!n.success)throw Error("Payment processing failed");u.success(`Booking confirmed! Payment of ${d(r.totalPrice||0)} processed.`);try{const e=P(A(h,"bookings"),S("listingId","==",r.listingId),S("status","==","pending")),s=await T(e),t=new Date(r.checkIn),n=new Date(r.checkOut);t.setHours(0,0,0,0),n.setHours(0,0,0,0);const i=[];if(s.forEach(e=>{const s=e.data();if(e.id===se.id)return;const a=new Date(s.checkIn),o=new Date(s.checkOut);a.setHours(0,0,0,0),o.setHours(0,0,0,0),n>a&&o>t&&i.push(e.id)}),i.length>0){const e=i.map(e=>g(e,{status:"cancelled"}));await Promise.all(e),1===i.length?u.info("1 overlapping booking request was automatically declined."):u.info(i.length+" overlapping booking requests were automatically declined.")}}catch(t){}}catch(n){return await g(se.id,{status:l}),void u.error("Payment failed: "+(n.message||"Insufficient balance or processing error"))}if("cancelled"===se.action&&"confirmed"===l)try{const e=await p(r,"host");if(!e.success)throw Error("Refund processing failed");u.success(`Booking cancelled. ${d(e.refundAmount||0)} has been refunded to guest's wallet.`)}catch(i){u.warning("Booking cancelled, but refund could not be processed. Please contact support.")}else"cancelled"===se.action&&u.success("Booking cancelled");if("confirmed"===se.action)try{const e=await z(O(h,"bookings",se.id));if(e.exists()){const s=e.data(),t=await z(O(h,"listing",s.listingId));if(t.exists()){const e=t.data();try{const t=await z(O(h,"users",s.guestId));if(t.exists()){const n=t.data();await x(n.email||s.guestId,n.fullName||"Guest",e.title||"Your Booking",e.location||"",s.checkIn,s.checkOut,s.guests||1,s.totalPrice||0,se.id)?u.success("Booking confirmed and confirmation email sent to guest!"):u.warning("Booking confirmed, but email could not be sent. Please check EmailJS configuration.")}else u.warning("Booking confirmed, but guest email not found.")}catch(a){"permission-denied"===a.code?u.error("Permission denied: Cannot access guest information. Please check Firestore rules."):u.warning("Booking confirmed, but could not fetch guest information for email.")}}else u.success("Booking confirmed, but listing details not found.")}else u.success("Booking confirmed, but details not found for email.")}catch(o){u.success("Booking confirmed, but email could not be sent.")}else"cancelled"===se.action&&"confirmed"!==r?.status&&u.success("Booking declined");te(null)}catch(c){u.error("Failed to update booking")}finally{W(!1),Z(!1),ee(!1)}};return t.jsxs("div",{className:"min-h-screen bg-background",children:[t.jsx("header",{className:"sticky top-0 z-50 border-b bg-card/95 backdrop-blur supports-[backdrop-filter]:bg-card/60 shadow-soft",children:t.jsxs("div",{className:"container mx-auto px-6 py-4 flex justify-between items-center",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(i,{variant:"ghost",size:"icon",onClick:()=>U("/host/dashboard"),children:t.jsx(E,{className:"h-5 w-5"})}),t.jsx("div",{className:"p-2 rounded-lg bg-secondary/10",children:t.jsx(R,{className:"w-5 h-5 text-secondary"})}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-lg font-bold",children:"Booking Requests"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Manage reservations"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(i,{variant:"ghost",size:"icon",onClick:()=>{ce()},title:"Refresh bookings",children:t.jsx(F,{className:"h-5 w-5"})}),t.jsx(w,{})]})]})}),t.jsx("div",{className:"max-w-6xl mx-auto p-6",children:K?t.jsx(a,{}):0===$.length?t.jsx(o,{children:t.jsxs(c,{className:"py-12 text-center",children:[t.jsx("p",{className:"text-muted-foreground mb-4",children:"No booking requests"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Bookings will appear here when guests make reservation requests for your listings."}),t.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Current host ID: ",Y?.uid]})]})}):t.jsx("div",{className:"grid gap-4",children:$.map(e=>t.jsxs(o,{children:[t.jsx(r,{children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs(l,{children:["Booking #",e.id.slice(0,8)]}),t.jsx(k,{children:e.status})]})}),t.jsx(c,{children:t.jsxs("div",{className:"space-y-4",children:[e.guestId&&ne[e.guestId]&&t.jsx("div",{className:"bg-muted/50 p-3 rounded-lg",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[t.jsx(G,{className:"h-4 w-4 text-muted-foreground"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-sm font-medium",children:ne[e.guestId].fullName||"Guest"}),t.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[t.jsx(H,{className:"h-3 w-3 text-muted-foreground"}),t.jsx("a",{href:"mailto:"+ne[e.guestId].email,className:"text-xs text-primary hover:underline",children:ne[e.guestId].email})]})]})]}),t.jsxs(i,{variant:"outline",size:"sm",onClick:()=>U("/host/messages?userId="+e.guestId),className:"flex items-center gap-2",children:[t.jsx(M,{className:"h-4 w-4"}),"Message"]})]})}),t.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Check-in"}),t.jsx("p",{className:"font-medium",children:new Date(e.checkIn).toLocaleDateString()})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Check-out"}),t.jsx("p",{className:"font-medium",children:new Date(e.checkOut).toLocaleDateString()})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Guests"}),t.jsxs("p",{className:"font-medium",children:[e.guests||1," guest",(e.guests||1)>1?"s":""]})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Total"}),t.jsx("p",{className:"font-medium",children:d(e.totalPrice||0)})]})]}),"pending"===e.status&&t.jsxs("div",{className:"flex gap-2 pt-2",children:[t.jsx(i,{size:"sm",onClick:()=>le(e.id,"confirmed"),className:"flex-1",children:"Confirm"}),t.jsx(i,{size:"sm",variant:"destructive",onClick:()=>le(e.id,"cancelled"),className:"flex-1",children:"Decline"})]}),"confirmed"===e.status&&new Date(e.checkIn)>=new Date&&t.jsx("div",{className:"pt-2 border-t",children:t.jsxs(i,{variant:"destructive",size:"sm",onClick:()=>le(e.id,"cancelled"),className:"w-full",children:[t.jsx(L,{className:"h-4 w-4 mr-2"}),"Cancel Booking"]})})]})})]},e.id))})}),t.jsx(b,{open:Q,onOpenChange:W,children:t.jsxs(N,{children:[t.jsxs(v,{children:[t.jsx(y,{children:"Confirm Booking?"}),t.jsx(B,{children:"Are you sure you want to confirm this booking? The guest will be notified and the booking will be finalized."})]}),t.jsxs(C,{children:[t.jsx(I,{onClick:()=>te(null),children:"Cancel"}),t.jsx(D,{onClick:de,children:"Confirm Booking"})]})]})}),t.jsx(b,{open:X,onOpenChange:Z,children:t.jsxs(N,{children:[t.jsxs(v,{children:[t.jsx(y,{children:"Decline Booking?"}),t.jsx(B,{children:"Are you sure you want to decline this booking request? The guest will be notified and this action cannot be undone."})]}),t.jsxs(C,{children:[t.jsx(I,{onClick:()=>te(null),children:"Cancel"}),t.jsx(D,{onClick:de,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Decline Booking"})]})]})}),t.jsx(b,{open:_,onOpenChange:ee,children:t.jsxs(N,{children:[t.jsxs(v,{children:[t.jsx(y,{children:"Cancel Booking?"}),t.jsxs(B,{children:["Are you sure you want to cancel this confirmed booking?",se&&(()=>{const e=$.find(e=>e.id===se.id);return e&&e.totalPrice>0?t.jsxs("div",{className:"mt-2 p-3 bg-muted rounded-md",children:[t.jsx("p",{className:"text-sm font-medium",children:"Refund Information:"}),t.jsxs("p",{className:"text-sm text-muted-foreground",children:["A refund of ",d(e.totalPrice)," will be credited to the guest's wallet balance."]})]}):null})()]})]}),t.jsxs(C,{children:[t.jsx(I,{onClick:()=>te(null),children:"Keep Booking"}),t.jsx(D,{onClick:de,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Cancel Booking"})]})]})})]})};export{U as default};
